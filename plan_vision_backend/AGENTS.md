# Repository Guidelines

## Project Structure & Module Organization
- `src/` hosts NestJS modules (`app.module.ts`, controllers, services, and the `main.ts` bootstrapper); add new feature modules inside subfolders here.
- `src/auth/` holds the Better Auth config (`auth.config.ts`) that wires the Nest module to Postgres via Kysely/pg and defines auth routes under `/api/auth`.
- `src/user/` now only serves `/users/me`, syncing Prisma user records from Better Auth sessions on demand; all other user lifecycle actions happen via Better Auth.
- `src/project/`, `src/input-image/`, `src/image-type/`, `src/style/`, and `src/render-config/` provide CRUD controllers for the respective lookup/content tables referenced by render jobs. `src/storage/` manages Google Cloud Storage uploads to the `planvision-uploads` bucket.
- `test/` provides Jest E2E specs plus `jest-e2e.json`; keep HTTP-level scenarios in this tree.
- `dist/` is the compiled output generated by `pnpm build`; never edit it manually.
- Root configs (`tsconfig*.json`, `eslint.config.mjs`, `nest-cli.json`) control compilation, linting, and the CLI; adjust them instead of duplicating settings elsewhere.

## Build, Test, and Development Commands
- `pnpm install` — sync dependencies defined in `package.json` and `pnpm-lock.yaml`.
- `pnpm start:dev` — run the Nest dev server with live reload; default entry point is `src/main.ts` (serves Swagger UI at `/docs`).
- `pnpm build` — transpile TypeScript into `dist/` via `nest build`; run locally/CI to surface TypeScript or DI errors before committing or deploying.
- `pnpm start:prod` — execute the compiled bundle (`node dist/main`).
- `pnpm test`, `pnpm test:watch`, `pnpm test:cov`, `pnpm test:e2e` — run unit specs, watch mode, coverage, and the E2E suite respectively.
- `pnpm lint` and `pnpm format` — enforce ESLint + Prettier; fix style issues before pushing.
- Prisma-specific: `pnpm prisma:generate` (refresh client after schema edits), `pnpm prisma:migrate` (apply local migrations), and `pnpm prisma:studio` (inspect the database UI).

## Coding Style & Naming Conventions
- TypeScript, ES2020 modules, and strict typing via `tsconfig.json`; stick to NestJS’s dependency-injected architecture.
- Use 2-space indentation, single quotes, and trailing commas where Prettier enforces them.
- Classes/services/controllers use `PascalCase`, providers/functions `camelCase`, and files `kebab-case` when creating new modules (`plans.controller.ts`).
- Place interfaces and DTOs near their modules inside `src/<feature>/dto/`.

## Testing Guidelines
- Unit specs live beside the code as `*.spec.ts` (see `src/app.controller.spec.ts`); mock external calls rather than hitting live services.
- Coverage reports land in `coverage/` (configured via Jest); aim to keep statements above 80% and add regression tests for bug fixes.
- Name test blocks with the behavior under test (`describe('PlanService', () => ...)`); include at least one E2E spec in `test/app.e2e-spec.ts` per feature slice.

## Commit & Pull Request Guidelines
- History currently only shows `initial commit`, so establish clear, imperative messages going forward (prefer Conventional Commits: `feat: add plan reporting API`).
- Keep branches focused on one concern, reference issue IDs when available, and describe behavior changes plus manual test evidence in PR summaries.
- Include screenshots or sample JSON payloads when modifying controllers, and ensure CI (lint + tests) passes before requesting review.

## Security & Auth Notes
- Better Auth mounts at `BETTER_AUTH_BASE_PATH` (default `/api/auth`) and expects the env vars defined in `.env` (`BETTER_AUTH_SECRET`, base URL/path, trusted origins, optional Google OAuth credentials); restart the Nest server after changes.
- `src/auth/auth.controller.ts` exposes first-party routes (`/auth/session`, `/auth/accounts`, `/auth/token`, `/auth/password/reset/*`, `/auth/email/*`) that forward to Better Auth’s API and return JSON suited for SPAs/mobile clients; all are documented in Swagger.
- `main.ts` disables Nest’s body parser so the auth middleware can verify signatures; rely on the built-in `@Session`, `@AllowAnonymous`, `@OptionalAuth`, and `@Roles` decorators from `@thallesp/nestjs-better-auth` to control access.
- `/users/me` automatically syncs a Prisma `User` record from the Better Auth session; other routes remain open unless you remove their `@AllowAnonymous()` decorators.
- Google Cloud Storage uploads require either a `GOOGLE_APPLICATION_CREDENTIALS` file or the base64-encoded `GCS_SERVICE_ACCOUNT_KEY` (plus optional `GCP_PROJECT_ID`) along with the `GCS_BUCKET` env var (set to `planvision-uploads`); `POST /input-images/upload` accepts `multipart/form-data` with a `file` field, stores it in the bucket, and persists the object name. Use `GET /input-images/:id/url` to retrieve a 1-hour signed URL for download so the bucket can remain private.
